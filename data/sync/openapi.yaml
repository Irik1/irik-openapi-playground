openapi: 3.1.0
info:
  title: Sync API
  description: API documentation for the Sync and Analytics ingestion services
  version: 1.0.0
servers:
  - url: http://localhost:8080
    description: Local server
  - url: https://api.dev.appewa.com/sync/v1
    description: Dev server
  - url: https://api.appewa.com/sync/v1
    description: Prod server
paths:
  /validate:
    post:
      summary: Validate events
      description: Validate events
      security:
        - jwtTokenAuth: []
      parameters:
        - name: custom_user_param
          in: query
          description: If true, user_id will be empty
          schema:
            type: boolean
            example: false
          required: false
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommonEventFieldsArray'
          application/x-ndjson: # NDJSON format supported for bulk events
            schema:
              $ref: '#/components/schemas/CommonEventFields'
      responses:
        200:
          description: OK
        401:
          $ref: '#/components/responses/UnauthorizedError'
        400:
          $ref: '#/components/responses/BadRequestError'
  /sync:
    get:
      summary: Sync events
      description: Sync events
      parameters:
        - name: since
          in: query
          description: Since timestamp in milliseconds
          schema:
            type: integer
            format: int64
            example: 1719000000000
          required: false
        - name: event_type
          in: query
          description: Event type filter (one of content_type)
          schema:
            type: string
            example: book, lesson, game, ai_dialog
          required: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommonEventFieldsArray'
  /analytics/api/{version}/events:
    get:
      summary: Handle events from query params
      description: handle events from query params
      security:
        - jwtTokenAuth: []
      operationId: handleEventsGet
      parameters:
        - name: version
          in: path
          schema:
            type: string
            example: v1
          required: true
        - name: session_id
          in: query
          schema:
            type: integer
            format: int64
        - name: customer_user_id
          in: query
          schema:
            type: string
        - name: random_user_id
          in: query
          schema:
            type: string
        - name: app_id
          in: query
          schema:
            type: string
        - name: app_version
          in: query
          schema:
            type: string
        - name: store
          in: query
          schema:
            type: string
        - name: tracker
          in: query
          schema:
            type: string
        - name: tracker_name
          in: query
          schema:
            type: string
        - name: network_name
          in: query
          schema:
            type: string
        - name: campaign_name
          in: query
          schema:
            type: string
        - name: adgroup_name
          in: query
          schema:
            type: string
        - name: creative_name
          in: query
          schema:
            type: string
        - name: installed_at_milli
          in: query
          schema:
            type: integer
            format: int64
        - name: connection_type
          in: query
          schema:
            type: string
        - name: adjust_tracker_id
          in: query
          schema:
            type: string
        - name: idfa
          in: query
          schema:
            type: string
        - name: idfv
          in: query
          schema:
            type: string
        - name: android_id
          in: query
          schema:
            type: string
        - name: gps_adid
          in: query
          schema:
            type: string
        - name: oaid
          in: query
          schema:
            type: string
        - name: web_uuid
          in: query
          schema:
            type: string
        - name: web_hwid
          in: query
          schema:
            type: string
        - name: language
          in: query
          schema:
            type: string
        - name: device_name
          in: query
          schema:
            type: string
        - name: device_type
          in: query
          schema:
            type: string
        - name: os_name
          in: query
          schema:
            type: string
        - name: os_version
          in: query
          schema:
            type: string
        - name: user_agent
          in: query
          schema:
            type: string
        - name: ip_address
          in: query
          schema:
            type: string
        - name: country
          in: query
          schema:
            type: string
        - name: platform
          in: query
          schema:
            type: string
        - name: event_id
          in: query
          schema:
            type: string
        - name: environment
          in: query
          schema:
            type: string
        - name: att_status
          in: query
          schema:
            type: integer
        - name: timezone
          in: query
          schema:
            type: string
        - name: push_token
          in: query
          schema:
            type: string
        - name: created_at_milli
          in: query
          schema:
            type: integer
            format: int64
        - name: event
          in: query
          schema:
            type: string
        - name: event_name
          in: query
          schema:
            type: string
        - name: event_type
          in: query
          schema:
            type: string
        - name: event_subtype
          in: query
          schema:
            type: string
        - name: sub_session_id
          in: query
          schema:
            type: integer
            format: int64
        - name: sub_session_type
          in: query
          schema:
            type: string
        - name: native_language
          in: query
          schema:
            type: string
        - name: learning_language
          in: query
          schema:
            type: string
        - name: sdk_version
          in: query
          schema:
            type: string
        - name: event_value
          in: query
          schema:
            type: string
          description: Event value in JSON format
        - name: event_value_b64
          in: query
          schema:
            type: string
          description: Base64 encoded event value replaces event_value if present
    post:
      summary: Handle events from body
      description: Handle events from body
      security:
        - jwtTokenAuth: []
      operationId: handleEventsPost
      parameters:
        - name: version
          in: path
          schema:
            type: string
            example: v1
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalyticsEvent'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  event_id:
                    type: string
                    example: 64a02559-1918-4caf-8d57-fc7633e85b5e
                    description: Event ID
        401:
          $ref: '#/components/responses/UnauthorizedError'
        400:
          $ref: '#/components/responses/BadRequestError'
  /internal/api/{version}/centrifugo/events/{event}:
    post:
      summary: Handle centrifugo events
      description: Handle centrifugo events
      security:
        - jwtTokenAuth: []
      operationId: handleCentrifugoEvents
      parameters:
        - name: version
          in: path
          schema:
            type: string
            example: v1
          required: true
        - name: event
          in: path
          schema:
            type: string
            enum:
              - connect
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: object
                    properties:
                      data:
                        type: object
                        properties:
                          connecting_ip:
                            type: string
                          connecting_ip_country:
                            type: string
                          connecting_x_ray:
                            type: string
                          connecting_user_agent:
                            type: string
        403:
          description: Forbidden
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Forbidden
        501:
          description: Not implemented
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Not implemented
components:
  responses:
    UnauthorizedError:
      description: Access token is missing or invalid
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Unauthorized
    BadRequestError:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Bad request
  securitySchemes:
    jwtTokenAuth: # arbitrary name for the security scheme
      type: apiKey
      name: x-session-id
      in: header
      description: JWT token
  schemas:
    CommonEventFieldsArray:
      type: array
      items:
        $ref: '#/components/schemas/CommonEventFields'
    CommonEventFields:
      type: object
      required:
        - learning_language
        - native_language
        - udid
        - app_id
        - transaction_id
        - content_id
        - content_type
        - action_type
        - created_at
        - timezone
      properties:
        learning_language:
          type: string
          example: en
          description: Learning language
        native_language:
          type: string
          example: ru
          description: Native language
        udid:
          type: string
          example: 00008030-000365EE222A802E
          description: Unique device ID
        app_id:
          type: string
          example: com.ewa.ewakids
          description: Application ID
        transaction_id:
          type: string
          example: baf0be6f-6b66-4b12-b978-6ba5094bae30
          description: Transaction ID
        content_id:
          type: string
          example: '1234567890'
          description: Content ID
        content_type:
          type: string
          example: book, lesson, game, ai_dialog
          description: Content type
        action_type:
          type: string
          example: lesson_completed
          description: Action type depends on the content_type
        created_at:
          type: integer
          format: int64
          example: 1719000000000
          description: Created at in milliseconds
        timezone:
          type: string
          example: +0300
          description: Timezone
        received_at:
          type: integer
          format: int64
          example: 1719000000000
          description: Received at in milliseconds
        user_id:
          type: string
          example: 5a704fb9-99d5-4495-ab71-e1a66a4b0bf0
          description: User ID
        x-session-id:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNWE3MDRmYjktOTlkNS00NDk1LWFjNzEtZTFhNjZhNGIwYmZmIiwiaWF0IjoxNzE5MDAwMDAwLCJleHAiOjE3MTk5NjQwMDB9.1234567890
          description: Session ID jwt token
        experience_rcvd:
          type: integer
          example: 15
          format: int32
          minimum: 0
          maximum: 500
          description: Experience received for one of the actions
        energy:
          type: integer
          example: 100
          format: int32
          minimum: -50
          maximum: 10000
          description: Energy received for one of the actions
        value_integer:
          type: integer
          example: 100
          format: int64
          description: Value integer
        value_string:
          type: string
          example: some extra string
          description: Value string
        value_float:
          type: number
          example: 100.5
          format: double
          description: Value float
        extra_json:
          type: string
          example: {"key": "value"}
          description: Extra JSON
    AnalyticsEvent:
      type: object
      properties:
        session_id:
          type: integer
        customer_user_id:
          type: string
        random_user_id:
          type: string
        app_id:
          type: string
        app_version:
          type: string
        store:
          type: string
        tracker:
          type: string
        tracker_name:
          type: string
        network_name:
          type: string
        campaign_name:
          type: string
        adgroup_name:
          type: string
        creative_name:
          type: string
        installed_at_milli:
          type: integer
        connection_type:
          type: string
        adjust_tracker_id:
          type: string
        idfa:
          type: string
        idfv:
          type: string
        android_id:
          type: string
        gps_adid:
          type: string
        oaid:
          type: string
        web_uuid:
          type: string
        web_hwid:
          type: string
        language:
          type: string
        device_name:
          type: string
        device_type:
          type: string
        os_name:
          type: string
        os_version:
          type: string
        user_agent:
          type: string
        ip_address:
          type: string
        country:
          type: string
        platform:
          type: string
        event_id:
          type: string
        environment:
          type: string
        att_status:
          type: integer
        timezone:
          type: string
        push_token:
          type: string
        created_at_milli:
          type: integer
        event:
          type: string
        event_name:
          type: string
        event_type:
          type: string
        event_subtype:
          type: string
        sub_session_id:
          type: integer
        sub_session_type:
          type: string
        native_language:
          type: string
        learning_language:
          type: string
        sdk_version:
          type: string
        event_value:
          type: string
